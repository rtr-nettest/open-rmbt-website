<app-header></app-header>
<app-top-nav></app-top-nav>
<app-breadcrumbs [currentRoute]="currentRoute"></app-breadcrumbs>
@defer { @if(visualization$ | async; as visualization) {
<ng-container *ngTemplateOutlet="loopHeader"></ng-container>
<div class="app-wrapper">
  @if (disableGraphics()) {
  <div style="margin-bottom: 40px">
    <app-iframe-test
      [showFooter]="false"
      [isWaitingForNextTest]="loopWaiting()"
      [waitingProgress]="progress()"
      [waitingProgressMs]="progressMs()"
    >
    </app-iframe-test>
  </div>
  } @else {
  <div class="app-main">
    <div class="app-progress-bar-wrapper">
      <app-gauge
        *ngIf="loopWaiting() !== true; else loopWaitProgressBar"
      ></app-gauge>
    </div>
    <app-spacer></app-spacer>
    <app-interim-results></app-interim-results>
  </div>
  }
</div>
<div
  class="app-wrapper"
  *ngIf="(isLoopModeEnabled$ | async) === true"
  style="margin-bottom: 40px"
>
  <app-recent-history
    *ngIf="result$ | async as result"
    [addMedian]="addMedian"
    [result]="result"
    [excludeColumns]="excludeColumns"
    [interruptsTests]="true"
    title="Recent measurements"
  ></app-recent-history>
</div>
} } @if (testStartDisabled()) {
<div class="app-wrapper">
  <h2 class="app-title" aria-live="polite">
    {{ "Measurement" | translate }}
  </h2>
  <h4 style="margin-bottom: 40px">
    {{
      "The measurement is not configured. Please fill the form and try again."
        | translate
    }}
  </h4>
</div>
}
<app-footer></app-footer>

<ng-template #loopWaitProgressBar>
  <div
    *ngIf="progressMode() as progressMode"
    style="
      display: flex;
      flex-direction: column;
      justify-content: center;
      margin-bottom: 40px;
      padding-right: 4rem;
    "
  >
    <div style="width: 100%">
      <ng-container *ngIf="progressMode === 'determinate'">
        <h4 class="app-title">
          {{ ("Next measurement in" | translate) + " " + progressFormatted() }}
        </h4>
      </ng-container>
      <mat-progress-bar
        class="app-progress-bar--loop"
        [mode]="progressMode"
        [value]="progress()"
      ></mat-progress-bar>
    </div>
  </div>
</ng-template>

<ng-template #loopHeader>
  <ng-container *ngIf="(isLoopModeEnabled$ | async) === true">
    <div class="app-wrapper" *ngIf="loopCount$ | async as loopCount">
      <h2 *ngIf="loopWaiting() !== true" class="app-title" aria-live="polite">
        {{ ("Measurement" | translate) + " " + loopCount }}
      </h2>
      <h2 *ngIf="loopWaiting() === true" class="app-title" aria-live="polite">
        {{
          "Result of measurement %0 - waiting" | translate | sprintf : loopCount
        }}
      </h2>
    </div>
  </ng-container>
</ng-template>
